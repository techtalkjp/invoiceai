# GitHub App 移行検討メモ

## 背景

現在の GitHub 連携は OAuth App + `repo` スコープで実装している。
クライアント企業の Organization の private リポジトリでの作業アクティビティを取得するには、
Org オーナーが OAuth App を承認する必要がある。

## 課題

- OAuth App の `repo` スコープは「全リポジトリにフルアクセス」と表示され、Org オーナーの心理的ハードルが高い
- Fine-grained PAT も Org のポリシー次第で承認が必要（OAuth App と大差ない）
- どの方式でも private repo へのアクセスには Org オーナーの関与が避けられない

## ターゲットの転換: 委託先 → 発注側（企業）

業務委託先がタイムシートや請求書を期日通りに送ってこない、という発注側の課題がある。

**企業側がこのツールを導入する**シナリオ:

- 企業が自社 Org に GitHub App をインストール（自分の Org なので承認の壁がない）
- 委託先メンバーのアクティビティ（コミット、PR、レビュー）が自動で可視化される
- 企業側でタイムシートのドラフトを作成し、委託先に確認・請求を促せる

## GitHub App のメリット

- **権限の粒度**: リポジトリ単位で read-only アクセスに絞れる（`Contents: read`, `Pull requests: read` 等）
- **インストール主体 = Org オーナー**: 自分の Org にインストールするので承認の壁がない
- **組織単位の管理**: 一度インストールすれば Org メンバー全員分のデータが取れる
- **Webhook**: push / PR イベントをリアルタイムで受信可能（既存の Webhook と統合しやすい）

## CLI アプローチ: OAuth の承認問題をバイパス

Web UI の GitHub 連携はどの方式でも Org オーナーの承認が必要になるが、
CLI（npx / ローカル実行）なら **ユーザー自身の認証情報** を使うのでこの問題が発生しない。

### データソース

- `git log` — ローカルにクローン済みのリポジトリからコミット履歴を取得。認証不要
- `gh api` — ユーザーが `gh auth login` 済みなら PR、レビュー、Issue コメントも取得可能。自分がアクセス権を持つ private repo もそのまま使える

### 想定フロー

```
委託先エンジニアのマシン:
  npx invoiceai sync --repo owner/repo --month 2026-02
    → git log / gh api でアクティビティ収集
    → InvoiceAI API にアクティビティを送信（or ローカルでタイムシート生成）

Web UI:
  → 受け取ったアクティビティを表示
  → タイムシート生成・PDF 出力・請求書作成
```

### メリット

- **Org オーナーの承認不要** — ユーザー自身の認証で動く
- **GitHub の権限モデルに依存しない** — Web 側は API でデータを受け取るだけ
- **既存の CLI 基盤を活用可能** — `src/cli/` が既にある
- **オフラインでも git log は動く**

### Web API 側に必要なもの

- アクティビティ受信 API エンドポイント（認証付き）
- CLI → Web の認証方式（API キー or トークン）

## GitHub App（Web 側の改善）

企業側がこのツールを導入するシナリオでは GitHub App も有効。

### 実装への影響（要調査）

- OAuth App → GitHub App への認証フロー変更
- Installation Access Token の管理（有効期限 1 時間、都度リフレッシュ）
- ユーザー認証（GitHub App の OAuth フロー）と App インストール（Installation）の使い分け
- 既存の `activity_source` テーブルのスキーマ変更（installation_id 等の追加）
- Webhook の署名検証方式の変更

## まとめ: 2つのアプローチは併用可能

| アプローチ             | 主体             | 承認                | ユースケース           |
| ---------------------- | ---------------- | ------------------- | ---------------------- |
| **CLI** (git log / gh) | 委託先エンジニア | 不要                | 自分の作業を自分で報告 |
| **GitHub App** (Web)   | 発注企業         | 自社 Org なので容易 | 委託先の作業を可視化   |

どちらか一方ではなく、両方を提供して入口を広げるのが理想。
